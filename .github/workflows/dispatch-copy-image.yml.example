name: GitHub action dispath

on:
  workflow_dispatch:
    inputs:
      test-regurl-tag:
        required: true
        default: ""
        description: "Container image URL with tag"
      prod-regurl:
        required: true
        default: ""
        description: "Container image URL WITHOUT tag"

env:
  TEST_IMAGE_WITH_TAG: ${{ github.env.inputs.test-url-tag }}
  PROD_IMAGE_URL: ${{ github.env.inputs.prod-url }}

jobs:
  copy_container_image:
    name: Copy container image
    runs-on: ubuntu-latest
    steps:
      - name: Get image tag
        run: |
          echo IMAGE_TAG=$(echo ${{ env.TEST_IMAGE_WITH_TAG }} | cut -d":" -f2) >> $GITHUB_ENV

      - uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{ secrets.SA }}

      - name: Configure Docker auth for gcloud command-line
        run: gcloud --quiet auth configure-docker && gcloud auth list
      
      - name: Pull from test
        run: docker pull ${{ env.TEST_IMAGE_WITH_TAG }}

      - name: Tag prod image
        run: docker tag ${{ env.TEST_IMAGE_WITH_TAG }} ${{ env.PROD_IMAGE_URL }}:${{ env.IMAGE_TAG }}

      - name: Push to prod
        run: docker push ${{ env.PROD_IMAGE_URL }}:${{ env.IMAGE_TAG }}

      - name: Summary
        run: |
          echo "TEST_IMAGE_WITH_TAG=${{ env.TEST_IMAGE_WITH_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "PROD_IMAGE=${{ env.PROD_IMAGE_URL }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY

      - uses: hmarr/debug-action@v2
        if: always()
